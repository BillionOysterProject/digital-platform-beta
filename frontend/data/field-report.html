---
page:
    body_class: 'site-details'

bindings:
- name:		'site'
  resource: '/api/sites/{{ param 1 }}'

- name:     'stations'
  resource: '/api/restoration-stations'
  fallback: []
  params:
    q: 'siteId/{{ param 1 }}'

- name:     'relatedTeams'
  resource: '/api/teams'
  fallback: []
  not_if:   '{{ isEmpty $.bindings.stations }}'
  params:
    q: 'teamLeads/{{ join (uniq (pluck $.bindings.stations "teamLead._id")) "|" }}'
    fields: 'teamLead,teamLeads,name'
    expand: false

- name:     'relatedExpeditions'
  resource: '/api/expeditions'
  not_if:   '{{ isEmpty $.bindings.stations }}'
  params:
    q:      'station/{{ join (pluck $.bindings.stations "_id") "|" }}/status/published'
    sort:   '-monitoringStartDate'
    expand: false
    limit:  100

- name: 'photos'
  resource: '/api/expeditions/photos'
  not_if:   '{{ isEmpty $.bindings.relatedExpeditions }}'
  params:
    q: '_id/{{ join (pluck $.bindings.relatedExpeditions "_id") "|" }}'
---

{{ $site     := $.bindings.site }}
{{ $stations := $.bindings.stations }}
{{ $teams    := $.bindings.relatedTeams }}

{{ range $i, $relatedTeam := $teams }}
{{   push "people" $relatedTeam.teamLead }}
{{   if (isArray $relatedTeam.teamLeads) }}
{{      range $j, $tl := $relatedTeam.teamLeads }}
{{        push "people" $tl }}
{{      end }}
{{   end }}
{{ end }}

{{ $people      := uniq $.vars.people }}
{{ $schoolOrgs  := (uniqByKey (filterByKey (pluck $.bindings.stations "schoolOrg") "name" "{{ not (hasPrefix (lower .) `unaffiliated`) }}") "name") }}
{{ $expeditions := $.bindings.relatedExpeditions }}
{{ $photos      := head (shuffle $.bindings.photos) 25 }}

<h1 class="text-left pb-0">Field Report for Expedition ["Name"] on [Date]</h1>
<section class="content shaded pt-1">
    <i class="fa fa-fw fa-map-marker"></i>
</section>


<div class="row no-gutters site-jumbotron">
    <div class="col">
        <div id="siteMap">        <iframe
            src="https://platform-beta.bop.nyc/sites/map"
            frameborder="0"
            style="width: 100%; height: 250px;"
        ></iframe></div>

    </div>
</div>

<section class="content">
<h2>Expedition Metadata</h2>
    <p>Metadata is information about the monitoring expedition.  This includes the site, the people who conducted the expedition, and the type of structure.</p>
    
    <ul class="list-unstyled">
        <div class="row">
            <div class="col-6">
                <li class="media">
                    <img class="img-thumbnail mr-3" src="https://avatars0.githubusercontent.com/u/16782836?s=200&v=4" alt="Generic placeholder image">
                    <div class="media-body">
                        <p class="mt-0 mb-1"><strong>Type of structure:</strong> Oyster Research Station</p>
                        <strong>Structure name:</strong> "Wutang Clams"
                    </div>
                </li>
            </div>
        
            <div class="col-6">
                <li class="media">
                    <img class="img-thumbnail mr-3" src="https://avatars0.githubusercontent.com/u/16782836?s=200&v=4" alt="Generic placeholder image">
                    <div class="media-body">
                        <p class="mt-0 mb-1"><strong>Team Lead:</strong> Ms. Pacman</p>
                        <strong>Team Name:</strong> "Fake Team"
                    </div>
                </li>
            </div>
        
            <div class="col-6 mt-3">
                <li class="media">
                    <img class="img-thumbnail mr-3" src="https://avatars0.githubusercontent.com/u/16782836?s=200&v=4" alt="Generic placeholder image">
                    <div class="media-body">
                        <p class="mt-0 mb-1"><strong>Organization Name:</strong> P.S. 1</p>
                        <strong>Organization Location:</strong> Red Hook, Brooklyn
                    </div>
                </li>
            </div>

            <div class="col-6 mt-3">
                <li class="media">
                    <img class="img-thumbnail mr-3" src="https://avatars0.githubusercontent.com/u/16782836?s=200&v=4" alt="Generic placeholder image">
                    <div class="media-body">
                        <p class="mt-0 mb-1"><strong>Number of Adults:</strong> 3</p>
                        <strong>Number of Students:</strong> 30
                    </div>
                </li>
            </div>

        </div>
    </ul>
</section>

<section class="content">
    <h2>Expedition Data</h2>
    <p>Billion Oyster Project is working to understand the best methods and locations to restore oysters in New York Harbor.
        We also want to understand what benefits to the harbor, or "ecosystem services," oysters might provide.
        You help us conduct this research by collecting data on:
        <ul>
            <li>Measures of oyster performance (like growth and mortality)</li>
            <li>Factors that affect oyster performance (like water quality)</li>
            <li>Diversity and abundance of non-oyster species</li>
        </ul>
        The data in this expedition represents one piece of a larger dataset that is growing with your help!
        To view data from multiple expeditions, use the <a href="https://platform-beta.bop.nyc/data">View Data</a> page.

    </p>
    
    <!--Oyster Measurements-->
    <div class="card border-1 mb-2">
        <div class="card-header" id="oysterMeasurementsData">
            <section class="shaded collapsed" data-toggle="collapse" data-target="#oysterMeasurement">
                <h3>Oyster Measurements</h3>
                <div class="step-toggle">
                    <i class="fa"></i>
                </div>
            </section>
        </div>

        <div id="oysterMeasurement" class="collapse" aria-labelledby="addOysterMeasurements" data-parent="#accordion">
            <div class="card-body">
                <p>
                    The Oyster Measurements protocol captures data on oyster growth and mortality.       
                </p>
                
                <div class="container-fluid" style="border-radius: 2em; background-color: #EEEEEE; margin-bottom: 2em; padding: 1.5em;">
                    <strong>Contributors to this protocol:</strong>                              
                    <ul class="list-group"> 
                        <div class="row"> 
                            <div class="col-6">                             
                                <li class="list-group-item">
                                        Johnny Userface
                                </li> 
                            </div> 
                            <div class="col-6">
                                <li class="list-group-item">
                                        Sally Shrimphead
                                </li>
                            </div>                      
                        </div>
                    </ul>
                </div>

                <div class="card mt-3 mb-3">
                    <div class="card-header">
                        <strong>Oyster Measurements Notes:</strong>
                    </div>
                    <div class="card-body">
                        Sample text about what happened at the site when investigating oysters...
                    </div>
                </div>

                <ul class="list-unstyled">
                    <li class="media">
                        <div class="col-3">
                            <img class="mr-3 img-thumbnail" src="https://billionoysterproject.org/wp-content/uploads/2016/11/2016-05-03-15.41.27-1.jpg" alt="Generic placeholder image">
                        </div>
                        <div class="media-body">
                            <strong>Bioaccumulation on Cage:</strong>
                            tbh kinda a lot
                        </div>
                    </li>
                </ul>

                <div class="mt-3">
                    <h4>Summary Data for This Expedition</h4>
                    <table class="table table-bordered">
                        <caption>Summary data on oyster mortality and growth, including the average oyster length and smallest and largest oysters.</caption> 
                        <tbody>
                            <tr>
                                <th scope="row">Mortality (from baseline)</th>
                                <td>50%</td>
                            </tr>
                            <tr>
                                <th scope="row">Growth Rate (from baseline)</th>
                                <td>20%</td>
                            </tr>
                            <tr>
                                <th scope="row">Average Oyster Length (the "Mean")</th>
                                <td>33 mm</td>
                            </tr>
                            <tr>
                                <th scope="row">Smallest Oyster (the "Minimum" or "Min")</th>
                                <td>25 mm</td>
                            </tr>
                            <tr>
                                <th scope="row">Largest Oyster (the "Maximum" or "Max")</th>
                                <td>55 mm</td>
                            </tr>
                        </tbody>
                    </table> 
                    
                </div>

                <h4>Oyster Mortality Data and Visualizations</h4>
                <p>
                    We can represent data on oyster mortality (how many oysters lived and died) in multiple ways.  
                    One format is a bar chart- this one shows the number of live oysters on each substrate shell during this expedition.
                </p>
                <p><strong>Bar Chart: Number of Live Oysters, This Expedition</strong></p>
                    <figure class="figure">
                        <div></div>
                        <img src="https://raw.githubusercontent.com/BillionOysterProject/digital-platform-beta/master/newplot%20(3).png" class="figure-img img-fluid rounded" alt="A generic square placeholder image with rounded corners in a figure.">
                        <figcaption class="figure-caption">The number of live oysters per substrate shell for this expedition.</figcaption>
                    </figure> 
                      
                <p>
                    We can also combine two bar charts to make comparisons between two datasets.  
                    This one uses different color bars to compare the number of live oysters at baseline vs. this expedition:
                </p>
                <p><strong>Bar Chart: Number of Live Oysters, Baseline vs. This Expedition</strong></p>
                <div>
                    <figure class="figure">
                        <div></div>
                            <img src="https://raw.githubusercontent.com/BillionOysterProject/digital-platform-beta/master/newplot%20(3).png" class="figure-img img-fluid rounded" alt="A generic square placeholder image with rounded corners in a figure.">
                            <figcaption class="figure-caption">The number of live oysters per substrate shell during the baseline expedition (in orange) and during this expedition (in blue).</figcaption>
                    </figure> 
                </div> 
                
                <div class="mt-3">
                    <p>A table is another way to visualize data using rows and columns.
                            This table uses a different row for each tagged substrate shell.  
                            It uses different columns to show the tag number, the source (where the oyster parents were from), the number of live oysters at baseline, and the number of live oysters during this expedition.
                            To calculate mortality, you take the number of live oysters during this expedition and divide it by the number of live oysters at baseline, and then express it as a percentage. 
                    </p>
                    <strong>Table: Mortality By Substrate Shell</strong>
                    <table class="table table-bordered">
                        <caption>The source and number of live oysters on each substrate shell at baseline and during this expedition, plus the mortality rate.</caption>
                        <thead>
                            <tr>
                                <th scope="col">Tag #</th>
                                <th scope="col">Source</th>
                                <th scope="col"># of live oysters at baseline</th>
                                <th scope="col"># of live oysters this expedition</th>
                                <th scope="col">Percent Mortality </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <th scope="row">1</th>
                                <td>Muscongus Bay, ME</td>
                                <td>20</td>
                                <td>10</td>
                                <td>50%</td>
                            </tr>
                            <tr>
                                <th scope="row">2</th>
                                <td>Muscongus Bay, ME</td>
                                <td>20</td>
                                <td>10</td>
                                <td>50%</td>
                            </tr>
                            <tr>
                                <th scope="row">3</th>
                                <td>Muscongus Bay, ME</td>
                                <td>20</td>
                                <td>10</td>
                                <td>50%</td>
                            </tr>
                            <tr>
                                <th scope="row">4</th>
                                <td>Muscongus Bay, ME</td>
                                <td>20</td>
                                <td>10</td>
                                <td>50%</td>
                            </tr>
                            <tr>
                                <th scope="row">5</th>
                                <td>Muscongus Bay, ME</td>
                                <td>20</td>
                                <td>10</td>
                                <td>50%</td>
                            </tr>
                            <tr>
                                <th scope="row">6</th>
                                <td>Muscongus Bay, ME</td>
                                <td>20</td>
                                <td>10</td>
                                <td>50%</td>
                            </tr>
                            <tr>
                                <th scope="row">7</th>
                                <td>Muscongus Bay, ME</td>
                                <td>20</td>
                                <td>10</td>
                                <td>50%</td>   
                            </tr>
                            <tr>
                                <th scope="row">8</th>
                                <td>Muscongus Bay, ME</td>
                                <td>20</td>
                                <td>10</td>
                                <td>50%</td>   
                            </tr>
                            <tr>
                                <th scope="row">9</th>
                                <td>Muscongus Bay, ME</td>
                                <td>20</td>
                                <td>10</td>
                                <td>50%</td>    
                            </tr>
                            <tr>
                                <th scope="row">10</th>
                                <td>Muscongus Bay, ME</td>
                                <td>20</td>
                                <td>10</td>
                                <td>50%</td>    
                            </tr>
                            <tr>
                                <th scope="row">TOTAL</th>
                                <td></td>
                                <td>200</td>
                                <td>100</td> 
                                <td>50%</td>   
                            </tr>                            
                        </tbody>
                    </table>
                </div>   

                <h4>Oyster Growth Data and Visualizations</h4>
                <p>
                    Different types of graphs can help you assess how well the oysters are growing at your site.
                    A bar chart is one way to visualize the lengths of each oyster during this expedition:
                </p>
                <p><strong>Bar Chart: Oyster Measurements</strong></p>
                
                    <figure class="figure">
                        <img src="https://raw.githubusercontent.com/BillionOysterProject/digital-platform-beta/master/each%20live%20oyster%20measurement%20sample.png" class="figure-img img-fluid rounded" alt="A generic square placeholder image with rounded corners in a figure.">
                        <figcaption class="figure-caption">The length, in millimeters, of each live oyster measured during this expedition, sorted from smallest to largest.</figcaption>
                    </figure> 
                
                <p>
                    A histogram is a different way to view the lengths of all of the live oysters.  
                    It splits all of the oyster measurements into even-sized groups by length (in 5mm increments) 
                    and tells you how many oysters are in each group.
                    A histogram is a good way to condense a large set of data into a smaller, more readable graph.
                </p>
                <p><strong>Histogram: Oyster Measurements</strong></p>
                    <figure class="figure">
                        <img src="https://raw.githubusercontent.com/BillionOysterProject/digital-platform-beta/master/newplot%20(2).png" class="figure-img img-fluid rounded" alt="A generic square placeholder image with rounded corners in a figure.">
                        <figcaption class="figure-caption"></figcaption>
                    </figure> 
                

                <p>
                    A box plot shows you what the smallest (min), largest (max), average (mean), and "normal" range of oyster measurements were for this expedition.  
                    The bottom and top lines represent the smallest and largest oyster measurements.
                    These lines show us the range of oyster measurements for this expedition.
                    The line in the middle of the box represents the average oyster measurement.  
                    The top and bottom lines of the box...

                </p>
                <p><strong>Box Plot: Oyster Measurements</strong></p>
                <div>
                    <figure class="figure">
                        <img src="https://raw.githubusercontent.com/BillionOysterProject/digital-platform-beta/master/unnamed.png" class="figure-img img-fluid rounded" alt="A generic square placeholder image with rounded corners in a figure.">
                        <figcaption class="figure-caption">  
                        </figcaption>
                    </figure> 
                </div>

                <div class="mt-3">
                    <h4>Table: Oyster Lengths</h4>
                    <table class="table table-bordered table-sm">
                        <caption>Oyster Lengths</caption> 
                        <thead>
                            <tr>
                                <th scope="col">Tag #</th>
                                <th scope="col">Oyster Length (mm)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <th scope="row">1</th>
                                <td>20</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="mt-3">
                        <h4>Photos</h4>
                        <div class="card" style="width: 18rem;">
                                <img class="card-img-top" src="https://billionoysterproject.org/wp-content/uploads/2016/11/DSCN2167-BBP-growth-calipers.jpg" alt="Card image cap">
                                <div class="card-body">
                                    <p class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</p>
                                </div>
                        </div>
                    </div>

            </div>
        </div>
    </div>

    <!--Site Conditions-->
    <div class="card border-1 mb-2">
        <div class="card-header" id="siteConditionsData">
            <section class="shaded collapsed" data-toggle="collapse" data-target="#siteConditions">
                <h3>Site Conditions</h3>
                <div class="step-toggle">
                    <i class="fa"></i>
                </div>
            </section>
        </div>

        <div id="siteConditions" class="collapse" aria-labelledby="siteConditionsData" data-parent="#accordion">
            <div class="card-body">
                    <p>
                        <em>This protocol captures data on meteorological conditions, recent rainfall,
                        and the environmental conditions of the land and water, including pollution and garbage. Site Conditions
                        can affect oysters by impacting water quality, particularly through Combined Sewer Overflows. Learn more.</em>        
                    </p>
            </div>
        </div>
    </div>


</section>


<section class="content">
        <h3>Mobile Organisms Data</h3>
        <div class="row">
                <div class="col-12">
                    <p>
                        <em>This protocol captures data on meteorological conditions, recent rainfall,
                        and the environmental conditions of the land and water, including pollution and garbage. Site Conditions
                        can affect oysters by impacting water quality, particularly through Combined Sewer Overflows. Learn more.</em>        
                    </p>
                </div>
                <div class="col-12"><strong>Notes:</strong></div>
        </div>
</section>

<section class="content">
        <h3>Sessile Organisms Data</h3>
        <div class="row">
                <div class="col-12">
                    <p>
                        <em>This protocol captures data on meteorological conditions, recent rainfall,
                        and the environmental conditions of the land and water, including pollution and garbage. Site Conditions
                        can affect oysters by impacting water quality, particularly through Combined Sewer Overflows. Learn more.</em>        
                    </p>
                </div>
                <div class="col-12"><strong>Notes:</strong></div>
        </div>
</section>

<section class="content">
        <h3>Water Quality Data</h3>
        <div class="row">
                <div class="col-12">
                    <p>
                        <em>This protocol captures data on meteorological conditions, recent rainfall,
                        and the environmental conditions of the land and water, including pollution and garbage. Site Conditions
                        can affect oysters by impacting water quality, particularly through Combined Sewer Overflows. Learn more.</em>        
                    </p>
                </div>
                <div class="col-12"><strong>Notes:</strong></div>
        </div>
</section>


<script type="text/javascript">
// Rebecca Elyanow 2018


function loadJSON(callback) {   

   var xobj = new XMLHttpRequest();
       xobj.overrideMimeType("application/json");
   xobj.open('GET', 'https://platform-beta.bop.nyc/api/expeditions/58112c8426915e7a0e4c14a8', true); // Replace 'my_data' with the path to your file
   xobj.onreadystatechange = function () {
         if (xobj.readyState == 4 && xobj.status == "200") {
           // Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode
           callback(xobj.responseText);
         }
   };
   xobj.send(null);  
}

function init() {
loadJSON(function(response) {
 // Parse JSON string into object
   actual_JSON = JSON.parse(response);
   console.log(actual_JSON);


   var live_oyster_size = get_oyster_size_single(actual_JSON,0.0,200.0).filter(Number);
   var number_live_oysters = get_number_live_oysters_single(actual_JSON,0.0,50.0).filter(Number);
   var baseline_oyster_size = live_oyster_size; // TODO
   // var total_mass_substrate_shell_oysters = get_total_mass_substrate_shell_oysters(actual_JSON,2.0,1000.0);

   console.log('oyster size',live_oyster_size.sort());
   plot(live_oyster_size,0.0,200.0,5.0,'Live oyster size (mm)','Live oyster size (mm)','Number of oysters','div_oyster_size');
   plot_barchart([...Array(live_oyster_size.length).keys()].map(String),live_oyster_size.sort(sortNumber),Math.round(live_oyster_size.length/10),10,'Live oyster size (mm)','Oyster','Live oyster size (mm)','div_barplot_oyster_size');
   plot_boxplot(baseline_oyster_size,live_oyster_size,Math.round(live_oyster_size.length/10),10,'Live oyster size (mm)','Oyster','Live oyster size (mm)','div_boxplot_oyster_size');
   // plot_dates(actual_JSON,get_oyster_size,0.0,200.0,5.0,'Live oyster size (mm)','Live oyster size (mm)','Number of oysters','div_dates_oyster_size')
   //plot_expeditions(actual_JSON,get_oyster_size,0.0,200.0,5.0,'Live oyster size (mm)','Live oyster size (mm)','Number of oysters','div_expeditions_oyster_size')

   plot(number_live_oysters,0.0,50.0,1.0,'Number of live oysters','Number of live oysters','Number of substrate shells','div_number_oysters');
   plot_barchart([...Array(number_live_oysters.length).keys()].map(String),number_live_oysters,1,1,'Number of live oysters','Substrate shell','Number of live oysters','div_barplot_number_oysters');
   // plot_dates(actual_JSON,get_number_live_oysters,0.0,50.0,1.0,'Number of live oysters','Number of live oysters','Number of substrate shells','div_dates_number_oysters')
   // plot_expeditions(actual_JSON,get_number_live_oysters,0.0,50.0,1.0,'Number of live oysters','Number of live oysters','Number of substrate shells','div_expeditions_number_oysters')

   // plot(total_mass_substrate_shell_oysters,0.0,1000.0,20.0,'Total mass of substrate shell oysters (g)','Total mass of substrate shell oysters (g)','Number of substrate shells','div_mass_oysters')
   // plot_dates(actual_JSON,get_total_mass_substrate_shell_oysters,0.0,1000.0,20.0,'Total mass of substrate shell oysters (g)','Total mass of substrate shell oysters (g)','Normalized number of substrate shells','div_dates_mass_oysters')
   // plot_expeditions(actual_JSON,get_total_mass_substrate_shell_oysters,0.0,1000.0,20.0,'Total mass of substrate shell oysters (g)','Total mass of substrate shell oysters (g)','Normalized number of substrate shells','div_expeditions_mass_oysters')
});
}

function sortNumber(a,b) {
   return a - b;
}

const concat = (x,y) =>
   x.concat(y)
const flatMap = (f,xs) =>
   xs.map(f).reduce(concat,[])

function get_date(actual_JSON) {
   var x = actual_JSON.map(function(y) {
       return y.collectionTime.substring(0,10).split('-').map(function(z) {
           return parseFloat(z);
       });
   });
   return x;
}

function date_difference(date1,date2) {
   var i;
   var diffs = date1;
   for (i = 0;i < date1.length;i++){
       var year_dif = (date2[i][0] - date1[i][0]) * 365;
       var month_dif = (date2[i][1] - date1[i][1]) * 12;
       var day_dif = date2[i][2] - date1[i][2];
       diffs[i] =  year_dif + month_dif + day_dif;}
   return diffs
}

function get_oyster_size(actual_JSON,min,max){
   var x = flatMap(function(x) {
       return flatMap(function(y) {
           return y.measurements.map(function(z) {
               return z.sizeOfLiveOysterMM;
           });
       },x.measuringOysterGrowth.substrateShells);
   },actual_JSON);//#.filter(Number);
   // x = x.filter(function(x) {
   //     return x <= max && x >= min;
   // });
   return x;
}

function get_oyster_size_single(actual_JSON,min,max){
   console.log('measuringOysterGrowth',actual_JSON.protocols.oysterMeasurement.measuringOysterGrowth.substrateShells);
   var x = flatMap(function(y) {
           return y.measurements.map(function(z) {
               return z.sizeOfLiveOysterMM;
           });
       },actual_JSON.protocols.oysterMeasurement.measuringOysterGrowth.substrateShells);//#.filter(Number);
   // x = x.filter(function(x) {
   //     return x <= max && x >= min;
   // });
   return x;
}


function get_means(actual_JSON){
   var d = flatMap(function(x) {
       return flatMap(function(y) {
           return y.measurements.map(function(z) {
               return y.averageSizeOfLiveOysters;
           });
       },x.measuringOysterGrowth.substrateShells);
   },actual_JSON);//.filter(Number);
   return d;
}

function get_size_means(actual_JSON){
   var x = flatMap(function(x) {
       return flatMap(function(y) {
           return y.measurements.map(function(z) {
               return y.averageSizeOfLiveOysters;
           });
       },x.measuringOysterGrowth.substrateShells);
   },actual_JSON).filter(Number);
   return x;
}

function get_number_live_oysters(actual_JSON,min,max){
   var x = flatMap(function(x) {
       return flatMap(function(y) {
           return y.totalNumberOfLiveOystersOnShell;
       },x.measuringOysterGrowth.substrateShells);
   },actual_JSON).filter(Number);
   x = x.filter(function(x) {
       return x <= max && x >= min;
   });
   return x;
}

function get_number_live_oysters_single(actual_JSON,min,max){
   var x = flatMap(function(y) {
           return y.totalNumberOfLiveOystersOnShell;
       },actual_JSON.protocols.oysterMeasurement.measuringOysterGrowth.substrateShells).filter(Number);
   return x;
}


function get_total_mass_substrate_shell_oysters(actual_JSON,min,max){
   var x = flatMap(function(x) {
       return flatMap(function(y) {
           return y.totalMassOfScrubbedSubstrateShellOystersTagG;
       },x.measuringOysterGrowth.substrateShells);
   },actual_JSON).filter(Number);
   x = x.filter(function(x) {
       return x <= max && x >= min;
   });
   return x;
}

function plot(x,start,end,size,title,xaxis,yaxis,div) {
   var trace = {
       x: x,
       type: 'histogram',
       xbins: {
           end: end, 
           size: size, 
           start: start
         }
     };
   var data = [trace];
   var layout = {
     bargap: 0.05, 
     title: title, 
     xaxis: {title: xaxis}, 
     yaxis: {title: yaxis},
     width: 700,
     height: 500,
   };
   Plotly.newPlot(div, data,layout);

}

function plot_dates(actual_JSON,datafun,start,end,size,title,xaxis,yaxis,div) {
   var data_2016 = actual_JSON.filter(function(x) {
       return x.collectionTime.includes('2016');
   });
   var data_2017 = actual_JSON.filter(function(x) {
       return x.collectionTime.includes('2017');
   });
   var data_2018 = actual_JSON.filter(function(x) {
       return x.collectionTime.includes('2018');
   });
   var vector_2016 = datafun(data_2016,start,end);
   var vector_2017 = datafun(data_2017,start,end);
   var vector_2018 = datafun(data_2018,start,end);
   var trace_2016 = {
       x: vector_2016,
       type: 'histogram',
       histnorm: 'probability',
       opacity: 0.5,
       name: "2016",
       xbins: {
           end: end, 
           size: size, 
           start: start
         },
       marker: {
            color: 'red',
             }
     };
   var trace_2017 = {
       x: vector_2017,
       type: 'histogram',
       name: "2017",
       opacity: 0.5,
       xbins: {
           end: end, 
           size: size, 
           start: start
         },
       marker: {
            color: 'blue',
             }
     };
   var trace_2018 = {
       x: vector_2018,
       type: 'histogram',
       name: "2018",
       opacity: 0.5,
       xbins: {
           end: end, 
           size: size, 
           start: start
         },
       marker: {
            color: 'green',
             }
     };
   var data = [trace_2016,trace_2017,trace_2018];
   var layout = {
     bargap: 0.05, 
     bargroupgap: 0.1,
     title: title, 
     xaxis: {title: xaxis}, 
     yaxis: {title: yaxis},
     width: 700,
     height: 500,
   };
   Plotly.newPlot(div, data,layout);

}

function plot_expeditions(actual_JSON,datafun,start,end,size,title,xaxis,yaxis,div) {
   var map = new Map();
   actual_JSON.forEach(function(x) {
       var siteName = x.longitude + "," + x.latitude; // get ORS location from longitude and latitude
       if(map.has(siteName)) {
           map.get(siteName).push(x);
       } else {
           map.set(siteName,[x]);
       }
   });
   var data1 = [];
   var data2 = [];
   Array.from(map.values()).forEach(function(x) {
   if (x.length > 1){
   var val1 = x[0];
   var val2 = x[x.length-1];
   data1.push(val1);
   data2.push(val2);
   }
   });
   var diffs = date_difference(get_date(data1),get_date(data2));
   var i;
   for (i = 0; i < diffs.length; i++) { //swap if first data is after second date
       if (diffs[i] < 0) {
           var d1 = data1[i];
           var d2 = data2[i];
           data1[i] = d2;
           data2[i] = d1;
           diffs[i] = Math.abs(diffs[i]);
       }
   }
   var vector1 = datafun(data1,start,end); // get vector of data for first time point (oyster size, number of live oysters, ect.)
   var vector2 = datafun(data2,start,end); // get vector of data for last time point 

   var i;
   if (datafun == get_oyster_size){
       means1 = get_means(data1);
       means2 = get_means(data2);
       var difference_in_size_per_month = [];
       for (i = 0; i < vector1.length; i++) {
           if (vector1[i] >= 300) { // correct high values (assume off by factor of 10)
               vector1[i] = vector1[i]/10;
           }
           if (vector2[i] >= 300) { // correct high values
               vector2[i] = vector2[i]/10;
           }
           if (means1[i] >= 20 && vector2[i] < 10){
               vector2[i] = vector2[i]*10; //correct low values (cm instead of mm)
           }
           vector1 = vector1.filter(Number);
           vector2 = vector2.filter(Number);
           difference_in_size_per_month.push((vector2[i] - vector1[i]) / ((diffs[0]+1) / 30));
       }
       console.log('diffs',diffs.length);
       console.log('vectors',vector1.length,vector2.length);
       console.log(difference_in_size_per_month);
   }
   var trace1 = {
       x: vector1,
       type: 'histogram',
       opacity: 0.5,
       name: "First expedition",
       xbins: {
           end: end, 
           size: size, 
           start: start
         },
       marker: {
            color: 'red',
             }
     };
   var trace2 = {
       x: vector2,
       type: 'histogram',
       name: "Most recent expedition",
       opacity: 0.5,
       xbins: {
           end: end, 
           size: size, 
           start: start
         },
       marker: {
            color: 'blue',
             }
     };

   var data = [trace1,trace2];
   var layout = {
     bargap: 0.05, 
     bargroupgap: 0.1,
     title: title, 
     xaxis: {title: xaxis}, 
     yaxis: {title: yaxis},
     width: 700,
     height: 500,
   };
   Plotly.newPlot(div, data,layout);

}


function plot_barchart(x,y,xtick,ytick,title,xaxis,yaxis,div){
   console.log(x,y)
   var trace1 = {
     x: x,
     y: y,
     type: 'bar',
     bargap: 0.05, 
   };

   var data = [trace1];
   var layout = {
     bargap: 0.05, 
     title: title, 
     xaxis: {title: xaxis,dtick: xtick}, 
     yaxis: {title: yaxis,dtick: ytick},
     width: 700,
     height: 500,
   };
   Plotly.newPlot(div, data,layout);
}

function plot_boxplot(first,current,xtick,ytick,title,xaxis,yaxis,div){
   var trace1 = {
     y: first,
     type: 'box',
     bargap: 0.05, 
     name: "Baseline"
   };
   var trace2 = {
     y: current,
     type: 'box',
     bargap: 0.05, 
     name: "Current expedition"
   };

   var data = [trace2];
   var layout = {
     bargap: 0.05, 
     title: title, 
     xaxis: {title: xaxis,dtick: xtick}, 
     yaxis: {title: yaxis,dtick: ytick},
     width: 700,
     height: 500,
   };
   Plotly.newPlot(div, data,layout);
}

init()
</script>