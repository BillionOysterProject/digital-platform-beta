<div id="map"></div>

<script type="text/javascript">
    $(function() {
        mapboxgl.accessToken = '{{ $.page.mapbox.key }}';

        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/{{ qs `style` $.page.mapbox.style }}',
            failIfMajorPerformanceCaveat: true,
            center: [-73.98, 40.7064203],
            zoom:   10,
        });

        map.on('load', function() {
            // map.addLayer({
            //     "id": "seamarks",
            //     "type": "circle",
            //     "source": {
            //         "type": "vector",
            //         "tiles": [
            //             "http://localhost:9090/maps/seamarks/manmade/{z}/{x}/{y}.vector.pbf",
            //         ],
            //         // "minzoom": 1,
            //         // "maxzoom": 18
            //     },
            //     "source-layer": "manmade",
            //     "paint": {
            //         "circle-radius": 3,
            //         "circle-color": "#FF0000",
            //         "circle-stroke-width": 1,
            //         "circle-stroke-color": "#FFFFFF",
            //     },
            // });

            $.ajax({
                url: '/api/sites?' + $.param({
                    limit: false,
                    fields: 'name,bodyOfWater,latitude,longitude,nycParkName',
                }),
                success: function(sites) {
                    var layer = {
                        "id": "sites",
                        "type": "circle",
                        "source": {
                            "type": "geojson",
                            "data": {
                                "type": "FeatureCollection",
                                "features": [],
                            },
                        },
                        "paint": {
                            "circle-radius": 7,
                            "circle-color": "#415980",
                            "circle-stroke-width": 2,
                            "circle-stroke-color": "#FFFFFF",
                        },
                    };

                    $.each(sites, function(i, site){
                        var description = "<h1>" + site.name + ', ' + site.bodyOfWater + "</h1>";

                        if (site.nycParkName && site.nycParkName.length) {
                            description += "<br>";
                            description += "<i>NYC Park Name:</i> " + site.nycParkName;
                        }

                        description += "<br>";
                        description += "<center>";
                        description += '<a href="/restoration/sites/' + site._id + '" class="btn btn-sm btn-primary mt-2">';
                        description += '<i class="fa fa-fw fa-map-marker"></i>'
                        description += 'View Site';
                        description += '</a>';
                        description += "</center>";

                        var point = {
                            "type": "Feature",
                            "properties": {
                                "description": description,
                            },
                            "geometry": {
                                "type": "Point",
                                "coordinates": [
                                    parseFloat(site.longitude),
                                    parseFloat(site.latitude),
                                ],
                            },
                        };

                        layer.source.data.features.push(point);
                    });

                    map.addLayer(layer);
                },
            });
        });

        map.on('click', function(e) {
            try {
                var features = map.queryRenderedFeatures(e.point, {
                    layers: ['sites', 'seamarks'],
                });

                if (!features.length) {
                    return;
                }

                var feature = features[0];

                console.debug('ft.', feature);

                if (!feature.properties.description) {
                    feature.properties.description = '';

                    if (feature.properties.name) {
                        feature.properties.description += '<h1>' + feature.properties.name + '</h1>';
                    }

                    if (feature.properties.type) {
                        feature.properties.description += '<strong>' + feature.properties.type + '</strong>';
                    }
                }

                var currentPopup = new mapboxgl.Popup({ offset: [0, -15] })
                    .setLngLat(feature.geometry.coordinates)
                    .setHTML('<p>' + feature.properties.description + '</p>')
                    .setLngLat(feature.geometry.coordinates)
                    .addTo(map);
            } catch(e) {
                ;
            }
        });

        map.on('mousemove', function(e) {
            var features = map.queryRenderedFeatures(e.point, {
                layers: ['sites'],
            })

            if (features.length) {
                map.getCanvas().style.cursor = 'crosshair';
            } else {
                map.getCanvas().style.cursor = 'default';
            }
        });
    });
</script>
