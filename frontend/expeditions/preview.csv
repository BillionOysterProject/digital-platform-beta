---
layout: none
headers:
    'Content-Type': 'text/plain'

postprocessors:
- 'trim-empty-lines'

bindings:
- name:     'expeditions'
  resource: ':/api/expeditions'
  fallback: {}
  params:
    searchString: '{{ qs `search` }}'
    q:            '{{ qs `q` }}'
    expand:       false
    limit:        '{{ qs `limit` 10000 }}'
    offset:       '{{ qs `offset` 0 }}'
    sort:         '{{ qs `sort` }}'

- name:     'stations'
  resource: ':/api/restoration-stations'
  params:
    limit:  10000
    fields: ['name']

- name:     'teams'
  resource: ':/api/teams'
  params:
    limit:  10000
    fields: ['name', 'schoolOrg']

- name:     'organizations'
  resource: ':/api/school-orgs'
  params:
    limit:  10000
    fields: ['name']

- name:     'protocol1'
  resource: ':/api/protocol-site-conditions'
  params:
    q: '_id/is:{{ join (uniq (flatten (pluck .bindings.expeditions `protocols.siteCondition`))) `|` }}'
  only_if:  '{{ any (split (qs `groups` ``) `,`) `all` `weather` `tides` `land-water` }}'

- name:     'protocol2'
  resource: ':/api/protocol-oyster-measurements'
  params:
    q: '_id/is:{{ join (uniq (flatten (pluck .bindings.expeditions `protocols.oysterMeasurement`))) `|` }}'
  only_if:  '{{ any (split (qs `groups` ``) `,`) `all` `oysters` }}'

- name:     'protocol3'
  resource: ':/api/protocol-mobile-traps'
  params:
    q: '_id/is:{{ join (uniq (flatten (pluck .bindings.expeditions `protocols.mobileTrap`))) `|` }}'
  only_if:  '{{ any (split (qs `groups` ``) `,`) `all` `mobile` }}'

- name:     'protocol4'
  resource: ':/api/protocol-settlement-tiles'
  params:
    q: '_id/is:{{ join (uniq (flatten (pluck .bindings.expeditions `protocols.settlementTiles`))) `|` }}'
  only_if:  '{{ any (split (qs `groups` ``) `,`) `all` `settlement` }}'

- name:     'protocol5'
  resource: ':/api/protocol-water-qualities'
  params:
    q: '_id/is:{{ join (uniq (flatten (pluck .bindings.expeditions `protocols.waterQuality`))) `|` }}'
  only_if:  '{{ any (split (qs `groups` ``) `,`) `all` `waterquality` }}'
---
{{ var `headers` `Expedition - Date` `Expedition - Organization` `Expedition - Team` `Expedition - Name` `Expedition - ORS` }}

{{ $groups := compact (split (qs `groups` ``) `,`) }}
{{ range $index, $protocol := $.page.protocols }}
{{   range $protocol.data }}
{{     if any $groups `all` .group }}
{{       push `headers` (printf "%v - %v" $protocol.name .title) }}
{{       push (printf "fields_%.0f" (add $index 1)) .id }}
{{     end }}
{{   end }}
{{ end }}

{{ range $.bindings.expeditions }}
{{   $team      := firstByKey $.bindings.teams         `_id` .team               }}
{{   $org       := firstByKey $.bindings.organizations `_id` $team.schoolOrg._id }}
{{   $station   := firstByKey $.bindings.stations      `_id` .station            }}
{{   $protocol1 := firstByKey $.bindings.protocol1     `_id` .protocols.siteCondition     }}
{{   $protocol2 := firstByKey $.bindings.protocol2     `_id` .protocols.oysterMeasurement }}
{{   $protocol3 := firstByKey $.bindings.protocol3     `_id` .protocols.mobileTrap        }}
{{   $protocol4 := firstByKey $.bindings.protocol4     `_id` .protocols.settlementTiles   }}
{{   $protocol5 := firstByKey $.bindings.protocol5     `_id` .protocols.waterQuality      }}

{{   var `values` (time .monitoringStartDate `ymd`) $org.name $team.name .name $station.name }}

{{   range $.vars.fields_1 }}
{{     push `values` (get $protocol1 . ``) }}
{{   end }}
{{   range $.vars.fields_2 }}
{{     push `values` (get $protocol2 . ``) }}
{{   end }}
{{   range $.vars.fields_3 }}
{{     push `values` (get $protocol3 . ``) }}
{{   end }}
{{   range $.vars.fields_4 }}
{{     push `values` (get $protocol4 . ``) }}
{{   end }}
{{   range $.vars.fields_5 }}
{{     push `values` (get $protocol5 . ``) }}
{{   end }}
{{   push `lines` $.vars.values }}
{{ end }}

{{ tsv $.vars.headers $.vars.lines }}
